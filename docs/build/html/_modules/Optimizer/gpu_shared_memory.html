
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Optimizer.gpu_shared_memory &#8212; Infinity-Tomographic-Reconstruction 0.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/Optimizer/gpu_shared_memory';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Infinity-Tomographic-Reconstruction 0.1.0 documentation - Home"/>
    <img src="../../_static/logo.png" class="logo__image only-dark pst-js-only" alt="Infinity-Tomographic-Reconstruction 0.1.0 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    src
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    src
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Optimizer.gpu_shared_memory</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for Optimizer.gpu_shared_memory</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pycuda.compiler</span><span class="w"> </span><span class="kn">import</span> <span class="n">SourceModule</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<div class="viewcode-block" id="GPUSharedMemorySingleKernel">
<a class="viewcode-back" href="../../Optimizer.html#Optimizer.gpu_shared_memory.GPUSharedMemorySingleKernel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GPUSharedMemorySingleKernel</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EM_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_forward_projection_shared_mem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_backward_projection_shared_mem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_normal</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">a_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_cf</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">a_cf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_normal</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">b_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cf</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">b_cf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_normal</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">c_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_cf</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">c_cf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_normal</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">d_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cf</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">d_cf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_coef</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">adjust_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">im</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">half_crystal_pitch_xy</span> <span class="o">=</span> <span class="n">EM_obj</span><span class="o">.</span><span class="n">half_crystal_pitch_xy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fw_source_model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;PET&quot;</span><span class="p">,</span> <span class="s2">&quot;fw_single_kernel.c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fw_source_model</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fw_source_model_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bw_source_model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;PET&quot;</span><span class="p">,</span> <span class="s2">&quot;bw_single_kernel.c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bw_source_model</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fw_source_model_file</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_machine_C_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_forward_projection_shared_mem</span> <span class="o">=</span> <span class="n">SourceModule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fw_source_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_backward_projection_shared_mem</span> <span class="o">=</span> <span class="n">SourceModule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bw_source_model</span><span class="p">)</span>
        <span class="c1"># self.mod_forward_projection_shared_mem = SourceModule(&quot;&quot;&quot;__global__ void forward_projection</span>
        <span class="c1">#                                                                      (const int n, const int m, const int p, const float crystal_pitch_XY,const float crystal_pitch_Z,const float distance_between_array_pixel,int number_of_events, const int begin_event_gpu_limitation,  const int end_event_gpu_limitation, float *a, float *a_normal,</span>
        <span class="c1">#                                                                       float *a_cf, float *b,float *b_normal, float *b_cf,float *c,float *c_normal, float *c_cf, float *d, float *d_normal, float *d_cf, const int *A, const int *B,</span>
        <span class="c1">#                                                                       const int *C, float *sum_vor, const char *sensitivity_matrix, const float *im_old, const float *probability)</span>
        <span class="c1">#                                                 {</span>
        <span class="c1">#                                                    const int shared_memory_size = 256;</span>
        <span class="c1">#                                                     __shared__ float a_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float b_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float c_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float d_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float a_normal_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float b_normal_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float c_normal_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float d_normal_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float a_cf_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float b_cf_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float c_cf_shared[shared_memory_size];</span>
        <span class="c1">#</span>
        <span class="c1">#                                                     __shared__ float d_cf_shared[shared_memory_size];</span>
        <span class="c1">#                                                     __shared__ float sum_vor_shared[shared_memory_size];</span>
        <span class="c1">#                                                     /*</span>
        <span class="c1">#                                                    const int blockId = blockIdx.x+ blockIdx.y * gridDim.x+ gridDim.x * gridDim.y * blockIdx.z;</span>
        <span class="c1">#                                                    const int threadId= blockId * (blockDim.x * blockDim.y * blockDim.z)+ (threadIdx.z * (blockDim.x * blockDim.y))+ (threadIdx.y * blockDim.x)+ threadIdx.x;</span>
        <span class="c1">#                                                    */</span>
        <span class="c1">#                                                    int threadId=blockIdx.x *blockDim.x + threadIdx.x;</span>
        <span class="c1">#                                                    int e;</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    float d2;</span>
        <span class="c1">#                                                    float d2_normal;</span>
        <span class="c1">#                                                    float d2_cf;</span>
        <span class="c1">#                                                    float value;</span>
        <span class="c1">#                                                    float value_normal;</span>
        <span class="c1">#                                                    float value_cf;</span>
        <span class="c1">#                                                    float sum_vor_temp;</span>
        <span class="c1">#                                                    int index;</span>
        <span class="c1">#                                                    const float total_length =sqrt(4*crystal_pitch_Z*crystal_pitch_Z+4*crystal_pitch_XY*crystal_pitch_XY+distance_between_array_pixel*distance_between_array_pixel/4);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    const int number_events_max = end_event_gpu_limitation-begin_event_gpu_limitation;</span>
        <span class="c1">#                                                    const float error_pixel = 0.0000f;</span>
        <span class="c1">#                                                     if (threadIdx.x&gt;shared_memory_size)</span>
        <span class="c1">#                                                     {</span>
        <span class="c1">#                                                     return;</span>
        <span class="c1">#                                                     }</span>
        <span class="c1">#                                                     if(threadId&gt;=number_events_max)</span>
        <span class="c1">#                                                     {</span>
        <span class="c1">#                                                     return;</span>
        <span class="c1">#                                                     }</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    __syncthreads();</span>
        <span class="c1">#                                                    e = threadId;</span>
        <span class="c1">#                                                    int e_m = threadIdx.x;</span>
        <span class="c1">#                                                    a_shared[e_m] = a[e];</span>
        <span class="c1">#                                                    b_shared[e_m] = b[e];</span>
        <span class="c1">#                                                    c_shared[e_m] = c[e];</span>
        <span class="c1">#                                                    d_shared[e_m] = d[e];</span>
        <span class="c1">#                                                    a_normal_shared[e_m] = a_normal[e];</span>
        <span class="c1">#                                                    b_normal_shared[e_m] = b_normal[e];</span>
        <span class="c1">#                                                    c_normal_shared[e_m] = c_normal[e];</span>
        <span class="c1">#                                                    d_normal_shared[e_m] = d_normal[e];</span>
        <span class="c1">#                                                    a_cf_shared[e_m] = a_cf[e];</span>
        <span class="c1">#                                                    b_cf_shared[e_m] = b_cf[e];</span>
        <span class="c1">#                                                    c_cf_shared[e_m] = c_cf[e];</span>
        <span class="c1">#                                                    d_cf_shared[e_m] = d_cf[e];</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    sum_vor_shared[e_m] = sum_vor[e];</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    for(int k=0; k&lt;p; k++)</span>
        <span class="c1">#                                                    {</span>
        <span class="c1">#                                                        for(int j=0; j&lt;m; j++)</span>
        <span class="c1">#                                                        {</span>
        <span class="c1">#                                                             for(int l=0; l&lt;n; l++)</span>
        <span class="c1">#                                                                {</span>
        <span class="c1">#                                                                /*index = k+j*p+l*p*m;*/</span>
        <span class="c1">#                                                                index = l+j*n+k*m*n;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                if (sensitivity_matrix[index]!=0)</span>
        <span class="c1">#                                                                {</span>
        <span class="c1">#                                                                value = a_shared[e_m]*A[index]+b_shared[e_m]*B[index]+c_shared[e_m]*C[index]- d_shared[e_m];</span>
        <span class="c1">#                                                                d2 = error_pixel+crystal_pitch_Z * sqrt(a_shared[e_m]*a_shared[e_m] + b_shared[e_m]*b_shared[e_m] + c_shared[e_m]*c_shared[e_m]);</span>
        <span class="c1">#                                                                if (value &lt; d2 &amp;&amp; value &gt;=-d2 )</span>
        <span class="c1">#                                                                {</span>
        <span class="c1">#                                                                    value_normal = a_normal_shared[e_m]*A[index]+b_normal_shared[e_m]*B[index]+c_normal_shared[e_m] * C[index]-d_normal_shared[e_m];</span>
        <span class="c1">#                                                                    d2_normal = error_pixel+crystal_pitch_XY * sqrt(a_normal_shared[e_m]*a_normal_shared[e_m]+b_normal_shared[e_m]*b_normal_shared[e_m]+c_normal_shared[e_m]*c_normal_shared[e_m]);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                     if (value_normal &lt; d2_normal &amp;&amp; value_normal &gt;= -d2_normal)</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                     {</span>
        <span class="c1">#                                                                            value_cf = a_cf_shared[e_m]*A[index]+b_cf_shared[e_m]*B[index]+c_cf_shared[e_m] * C[index]-d_cf_shared[e_m];</span>
        <span class="c1">#                                                                             d2_cf = (distance_between_array_pixel/2)*sqrt(a_cf_shared[e_m]*a_cf_shared[e_m]+b_cf_shared[e_m]*b_cf_shared[e_m]+c_cf_shared[e_m]*c_cf_shared[e_m]);</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                        if ((value_cf &gt; -d2_cf) &amp;&amp; value_cf&lt;=d2_cf)</span>
        <span class="c1">#                                                                            {</span>
        <span class="c1">#                                                                             sum_vor_shared[e_m] += im_old[index]*(1-(sqrt(value*value+value_normal*value_normal+value_cf*value_cf))/sqrt(d2*d2+d2_normal*d2_normal+d2_cf*d2_cf));</span>
        <span class="c1">#                                                                              }</span>
        <span class="c1">#                                                                             /*</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                                sum_vor_temp += im_old[index]*(1-(sqrt(value*value+value_normal*value_normal+value_cf*value_cf))/sqrt(d2*d2+d2_normal*d2_normal+d2_cf*d2_cf));</span>
        <span class="c1">#                                                                             sum_vor_temp += im_old[index]*(1-(sqrt(value*value+value_normal*value_normal+value_cf*value_cf))/sqrt(d2*d2+d2_normal*d2_normal+distance_between_array_pixel*d2_cf*distance_between_array_pixel*d2_cf/4));</span>
        <span class="c1">#                                                                                if ( (value_cf&gt;=0 &amp;&amp; value_cf &lt; distance_between_array_pixel*d2_cf &amp;&amp; value_cf&gt;=d2_cf) || (value_cf&lt;0 &amp;&amp; value_cf &gt; -distance_between_array_pixel*d2_cf &amp;&amp; value_cf&lt;=d2_cf))</span>
        <span class="c1">#                                                                        {</span>
        <span class="c1">#                                                                        }</span>
        <span class="c1">#                                                                        *(1-abs(distance_between_array_pixel/2-value_cf)/distance_between_array_pixel/2)</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                             *(1-((sqrt(value*value+value_normal*value_normal+4*crystal_pitch_XY*crystal_pitch_XY))/sqrt(4*crystal_pitch_Z*crystal_pitch_Z+4*crystal_pitch_XY*crystal_pitch_XY+distance_between_array_pixel*distance_between_array_pixel)));</span>
        <span class="c1">#                                                                               sum_vor_shared[e_m] += im_old[index]*(1-((sqrt(value*value+value_normal*value_normal+4*crystal_pitch_XY*crystal_pitch_XY))/sqrt(4*crystal_pitch_Z*crystal_pitch_Z+4*crystal_pitch_XY*crystal_pitch_XY+distance_between_array_pixel*distance_between_array_pixel)));;</span>
        <span class="c1">#                                                                             sum_vor_shared[e_m] += im_old[index]*sensitivity_matrix[index]*(1-((sqrt(value*value+value_normal*value_normal))/sqrt(crystal_pitch_Z*crystal_pitch_Z+crystal_pitch_XY*crystal_pitch_XY+)));;</span>
        <span class="c1">#                                                                             sum_vor_shared[e_m] += im_old[index];</span>
        <span class="c1">#                                                                             sum_vor_temp += sensitivity_matrix[index]*im_old[index]*(1-(sqrt(value*value+value_normal*value_normal+4*crystal_pitch_XY*crystal_pitch_XY))/total_length);</span>
        <span class="c1">#                                                                             *(1-(sqrt(value*value+value_normal*value_normal+value_cf*value_cf))/total_length)</span>
        <span class="c1">#                                                                             (1-abs(value_cf)/(distance_between_array_pixel/2*d2_cf));</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                             ;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                         }</span>
        <span class="c1">#                                                                          */</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                    }</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                                }</span>
        <span class="c1">#                                                                }</span>
        <span class="c1">#</span>
        <span class="c1">#                                                             }</span>
        <span class="c1">#                                                         }</span>
        <span class="c1">#                                                     }</span>
        <span class="c1">#</span>
        <span class="c1">#                                                     /*</span>
        <span class="c1">#                                                     sum_vor[e]= sum_vor_shared[e_m];</span>
        <span class="c1">#                                                     sum_vor[e]= sum_vor_temp;</span>
        <span class="c1">#                                                     */</span>
        <span class="c1">#</span>
        <span class="c1">#                                                     __syncthreads();</span>
        <span class="c1">#                                                     sum_vor[e]= sum_vor_shared[e_m];</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                 }&quot;&quot;&quot;)</span>
        <span class="c1"># self.mod_backward_projection_shared_mem = SourceModule(&quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#                             __global__ void backprojection</span>
        <span class="c1">#                              ( int dataset_number, int n, int m, int p, const float crystal_pitch_XY, const float crystal_pitch_Z, const float distance_between_array_pixel, int number_of_events, const int begin_event_gpu_limitation, const int end_event_gpu_limitation, float *a, float *a_normal,</span>
        <span class="c1">#                               float *a_cf, float *b,float *b_normal, float *b_cf,float *c,float *c_normal,  float *c_cf, float *d, float *d_normal,  float *d_cf,const int *A, const int *B,</span>
        <span class="c1">#                               const int *C, float *adjust_coef, float *sum_vor, char *sensitivity_matrix, const float *probability, float *time_factor)</span>
        <span class="c1">#                            {</span>
        <span class="c1">#</span>
        <span class="c1">#                                /*</span>
        <span class="c1">#</span>
        <span class="c1">#                                int blockId = blockIdx.x+ blockIdx.y * gridDim.x+ gridDim.x * gridDim.y * blockIdx.z;</span>
        <span class="c1">#                                int idt= blockId * (blockDim.x * blockDim.y * blockDim.z)+ (threadIdx.z * (blockDim.x * blockDim.y))+ (threadIdx.y * blockDim.x)+ threadIdx.x;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                const int shared_memory_size = 143;</span>
        <span class="c1">#                                __shared__ float adjust_coef_shared[shared_memory_size];</span>
        <span class="c1">#</span>
        <span class="c1">#                                */</span>
        <span class="c1">#                                extern __shared__ float adjust_coef_shared[];</span>
        <span class="c1">#                                int blockId = blockIdx.x+ blockIdx.y * gridDim.x+ gridDim.x * gridDim.y * blockIdx.z;</span>
        <span class="c1">#                                int idt = blockId * blockDim.x + threadIdx.x;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                float d2;</span>
        <span class="c1">#                                float d2_normal;</span>
        <span class="c1">#                                float d2_cf;</span>
        <span class="c1">#                                float normal_value;</span>
        <span class="c1">#                                float value;</span>
        <span class="c1">#                                float value_cf;</span>
        <span class="c1">#                                float error_pixel = 0.000f;</span>
        <span class="c1">#                                float declive;</span>
        <span class="c1">#                                const float total_length = sqrt(4*crystal_pitch_Z*crystal_pitch_Z+4*crystal_pitch_XY*crystal_pitch_XY+distance_between_array_pixel*distance_between_array_pixel/4);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                int i_s=threadIdx.x;</span>
        <span class="c1">#</span>
        <span class="c1">#                                if (idt&gt;=n*m*p)</span>
        <span class="c1">#                                {</span>
        <span class="c1">#                                     return;</span>
        <span class="c1">#                                 }</span>
        <span class="c1">#                                 if (i_s&gt;n)</span>
        <span class="c1">#                                {</span>
        <span class="c1">#                                     return;</span>
        <span class="c1">#                                 }</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                 __syncthreads();</span>
        <span class="c1">#                                 adjust_coef_shared[i_s] = adjust_coef[idt];</span>
        <span class="c1">#</span>
        <span class="c1">#                                for(int e=begin_event_gpu_limitation; e&lt;end_event_gpu_limitation; e++)</span>
        <span class="c1">#                                {</span>
        <span class="c1">#                                        if (sensitivity_matrix[idt]!=0)</span>
        <span class="c1">#                                                                {</span>
        <span class="c1">#</span>
        <span class="c1">#                                        value = a[e]*A[idt]+b[e]*B[idt]+c[e]*C[idt]- d[e];</span>
        <span class="c1">#                                        d2 = error_pixel+ crystal_pitch_Z * sqrt(a[e]*a[e] + b[e]*b[e] + c[e]*c[e]);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                        if (value &lt; d2 &amp;&amp; value &gt;=-d2)</span>
        <span class="c1">#                                        {</span>
        <span class="c1">#                                            normal_value= a_normal[e]*A[idt]+b_normal[e]*B[idt]+c_normal[e] * C[idt]-d_normal[e];</span>
        <span class="c1">#</span>
        <span class="c1">#                                            d2_normal = error_pixel+crystal_pitch_XY * sqrt(a_normal[e]*a_normal[e]+b_normal[e]*b_normal[e]+c_normal[e]*c_normal[e]);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                             if (normal_value&lt; d2_normal &amp;&amp; normal_value &gt;= -d2_normal)</span>
        <span class="c1">#                                             {</span>
        <span class="c1">#</span>
        <span class="c1">#                                                  value_cf = a_cf[e]*A[idt]+b_cf[e]*B[idt]+c_cf[e] * C[idt]-d_cf[e];</span>
        <span class="c1">#                                                  d2_cf = distance_between_array_pixel/2*sqrt(a_cf[e]*a_cf[e]+b_cf[e]*b_cf[e]+c_cf[e]*c_cf[e]);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                    if ((value_cf &gt; -d2_cf) &amp;&amp; value_cf&lt;=d2_cf)</span>
        <span class="c1">#                                                    {</span>
        <span class="c1">#                                                         adjust_coef_shared[i_s] += (1-(sqrt(value*value+normal_value*normal_value+value_cf*value_cf))/sqrt(d2*d2+d2_normal*d2_normal+d2_cf*d2_cf))/(sum_vor[e]*time_factor[e]);</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                                   }</span>
        <span class="c1">#</span>
        <span class="c1">#                                                        /*</span>
        <span class="c1">#                                                      adjust_coef_shared[i_s] += (1-(sqrt(value*value+normal_value*normal_value+value_cf*value_cf))/sqrt(d2*d2+d2_normal*d2_normal+d2_cf*d2_cf))/(sum_vor[e]*time_factor[e]);</span>
        <span class="c1">#                                                         */</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                                             }</span>
        <span class="c1">#                                         }</span>
        <span class="c1">#</span>
        <span class="c1">#                                }</span>
        <span class="c1">#</span>
        <span class="c1">#                                }</span>
        <span class="c1">#</span>
        <span class="c1">#                                adjust_coef[idt] = adjust_coef_shared[i_s];</span>
        <span class="c1">#                                __syncthreads();</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                            }</span>
        <span class="c1">#                            &quot;&quot;&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_vor_design_gpu_shared_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer STARTED&#39;</span><span class="p">)</span>
        <span class="c1"># cuda.init()</span>
        <span class="n">cuda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EM_obj</span><span class="o">.</span><span class="n">cuda_drv</span>
        <span class="c1"># device = cuda.Device(0)  # enter your gpu id here</span>
        <span class="c1"># ctx = device.make_context()</span>
        <span class="n">number_of_events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image size: </span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BACKPROJECTION FUNCTION&#39;</span><span class="p">)</span>
        <span class="c1"># probability= self.probability</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_z</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">distance_between_array_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_between_array_pixel</span>

        <span class="c1"># SOURCE MODELS (DEVICE CODE)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_machine_C_code</span><span class="p">()</span>
        <span class="c1"># float crystal_pitch, int number_of_events, float *a, float *b, float *c, float *d, int *A, int *B, int *C, float *im, float *vector_matrix</span>
        <span class="c1"># Host Code   B, C, im, vector_matrix,</span>
        <span class="n">number_of_datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Number of datasets (and concurrent operations) used.</span>
        <span class="c1"># Start concurrency Test</span>
        <span class="c1"># Event as reference point</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">record</span><span class="p">()</span>

        <span class="c1"># Create the streams and events needed to calculation</span>
        <span class="n">stream</span><span class="p">,</span> <span class="n">event</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">marker_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;kernel_begin&#39;</span><span class="p">,</span> <span class="s1">&#39;kernel_end&#39;</span><span class="p">]</span>
        <span class="c1"># Create List to allocate chunks of data</span>
        <span class="n">A_cut_gpu</span><span class="p">,</span> <span class="n">B_cut_gpu</span><span class="p">,</span> <span class="n">C_cut_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">A_cut</span><span class="p">,</span> <span class="n">B_cut</span><span class="p">,</span> <span class="n">C_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_gpu</span><span class="p">,</span> <span class="n">b_gpu</span><span class="p">,</span> <span class="n">c_gpu</span><span class="p">,</span> <span class="n">d_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">a_normal_gpu</span><span class="p">,</span> <span class="n">b_normal_gpu</span><span class="p">,</span> <span class="n">c_normal_gpu</span><span class="p">,</span> <span class="n">d_normal_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_cut</span><span class="p">,</span> <span class="n">b_cut</span><span class="p">,</span> <span class="n">c_cut</span><span class="p">,</span> <span class="n">d_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">a_normal_cut</span><span class="p">,</span> <span class="n">b_normal_cut</span><span class="p">,</span> <span class="n">c_normal_cut</span><span class="p">,</span> <span class="n">d_normal_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_cf_cut</span><span class="p">,</span> <span class="n">b_cf_cut</span><span class="p">,</span> <span class="n">c_cf_cut</span><span class="p">,</span> <span class="n">d_cf_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_cut_gpu</span><span class="p">,</span> <span class="n">b_cut_gpu</span><span class="p">,</span> <span class="n">c_cut_gpu</span><span class="p">,</span> <span class="n">d_cut_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_cut_normal_gpu</span><span class="p">,</span> <span class="n">b_cut_normal_gpu</span><span class="p">,</span> <span class="n">c_cut_normal_gpu</span><span class="p">,</span> <span class="n">d_cut_normal_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">a_cf_cut_gpu</span><span class="p">,</span> <span class="n">b_cf_cut_gpu</span><span class="p">,</span> <span class="n">c_cf_cut_gpu</span><span class="p">,</span> <span class="n">d_cf_cut_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="n">time_factor_cut_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">sum_vor_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">sum_vor_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">probability_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">probability_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">adjust_coef_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">adjust_coef_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">sensivity_matrix_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">sensivity_cut</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>
        <span class="n">sensivity_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_datasets</span>

        <span class="c1"># Streams and Events creation</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">())</span>
            <span class="n">event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">marker_names</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">cuda</span><span class="o">.</span><span class="n">Event</span><span class="p">())</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">marker_names</span><span class="p">))]))</span>

        <span class="c1"># Memory Allocation</span>
        <span class="c1"># Variables that need an unique alocation</span>
        <span class="n">A_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">B_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">C_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">im_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">sensivity_matrix_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">sensivity_matrix</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">sensivity_matrix</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">A_gpu</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">B_gpu</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">C_gpu</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">im_gpu</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">sensivity_matrix_gpu</span><span class="p">,</span> <span class="n">sensivity_matrix</span><span class="p">)</span>

        <span class="n">a_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">b_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">c_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">d_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">a_normal_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">a_normal</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a_normal</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">b_normal_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">b_normal</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b_normal</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">c_normal_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">c_normal</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c_normal</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">d_normal_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">d_normal</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d_normal</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

        <span class="n">a_cf_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">a_cf</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a_cf</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">b_cf_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">b_cf</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b_cf</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">c_cf_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">c_cf</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c_cf</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">d_cf_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">d_cf</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d_cf</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">sum_vor_t_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">sum_vor</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">sum_vor</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">probability_t_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">probability</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">probability</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">time_factor_gpu</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">time_factor</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">time_factor</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="c1"># Transfer memory to Optimizer</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_gpu</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_gpu</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_gpu</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_gpu</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_normal_gpu</span><span class="p">,</span> <span class="n">a_normal</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_normal_gpu</span><span class="p">,</span> <span class="n">b_normal</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_normal_gpu</span><span class="p">,</span> <span class="n">c_normal</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_normal_gpu</span><span class="p">,</span> <span class="n">d_normal</span><span class="p">)</span>

        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_cf_gpu</span><span class="p">,</span> <span class="n">a_cf</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_cf_gpu</span><span class="p">,</span> <span class="n">b_cf</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_cf_gpu</span><span class="p">,</span> <span class="n">c_cf</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_cf_gpu</span><span class="p">,</span> <span class="n">d_cf</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">time_factor_gpu</span><span class="p">,</span> <span class="n">time_factor</span><span class="p">)</span>

        <span class="n">im_cut_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)]</span>  <span class="c1"># Dividing image in small chunks</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="n">number_of_datasets</span><span class="p">:</span>
                <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">number_of_events</span>
                <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">adjust_coef</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">adjust_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">adjust_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">adjust_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">sensivity_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">sensivity_matrix</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">sensivity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">sensivity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="n">sensivity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>

                <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">adjust_coef</span><span class="p">[:,</span> <span class="p">:,</span>
                                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span>
                                                                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">sensivity_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">sensivity_matrix</span><span class="p">[:,</span> <span class="p">:,</span>
                                                              <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span>
                                                                  <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span>
                                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">)</span>

                <span class="n">A_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span>
                                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span>
                                                          <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">B_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">B</span><span class="p">[:,</span> <span class="p">:,</span>
                                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span>
                                                          <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">C_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">C</span><span class="p">[:,</span> <span class="p">:,</span>
                                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span>
                                                          <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="c1"># Cutting dataset</span>
            <span class="c1"># For forward projection the data is cutted by number of events. For backprojection is cutted per image pieces of image</span>
            <span class="n">a_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">b_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">c_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">d_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">a_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_normal</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">b_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_normal</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">c_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_normal</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">d_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_normal</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>

            <span class="n">a_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_cf</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">b_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_cf</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">c_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_cf</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">d_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_cf</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_vor</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
            <span class="n">probability_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">probability</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>

            <span class="c1"># Forward</span>
            <span class="n">a_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">a_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">b_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">b_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">c_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">c_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">d_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">d_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">a_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">a_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">b_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">b_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">c_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">c_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">d_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">d_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">a_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">a_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">b_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">b_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">b_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">c_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">c_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">c_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">d_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">d_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">d_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">sum_vor_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">probability_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">probability_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">probability_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">sum_vor_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">probability_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">probability_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">a_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">b_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">c_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">d_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">a_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">b_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">c_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">d_normal_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">a_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">a_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">b_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">b_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">c_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">c_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">d_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">d_cf_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

            <span class="c1"># Backprojection</span>
            <span class="n">adjust_coef_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">sensivity_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">sensivity_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">sensivity_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">A_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">A_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">A_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">B_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">B_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">B_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">C_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
                <span class="n">C_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">C_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>

            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">adjust_coef_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">sensivity_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">sensivity_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">A_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">A_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">B_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">B_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">C_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">C_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

        <span class="n">free</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_get_info</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%%</span><span class="s1"> of device memory is free.&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">free</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

        <span class="c1"># -------------OSEM---------</span>
        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_iterations</span>
        <span class="n">subsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_subsets</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number events for reconstruction: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_events</span><span class="p">))</span>
        <span class="c1"># total_pixels_per_event = weight * height * depth</span>
        <span class="c1"># number_of_pixel_calculated_per_second = 3E9</span>
        <span class="c1"># time_to_prevent_watchdog = 1.8  # seconds</span>
        <span class="c1"># number_events_cutted_by_watchdog = np.int32(</span>
        <span class="c1">#     (number_of_pixel_calculated_per_second * time_to_prevent_watchdog) / total_pixels_per_event)</span>
        <span class="c1"># propability calculation</span>
        <span class="c1"># begin_event = np.int32(0)</span>
        <span class="c1"># end_event = np.int32(number_of_events / subsets)</span>
        <span class="c1"># number_of_events_subset = np.int32(end_event - begin_event)</span>
        <span class="c1"># for dataset in range(number_of_datasets):</span>
        <span class="c1">#</span>
        <span class="c1">#     if dataset == number_of_datasets:</span>
        <span class="c1">#         begin_dataset = np.int32(dataset * number_of_events_subset / number_of_datasets)</span>
        <span class="c1">#         end_dataset = number_of_events_subset</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         begin_dataset = np.int32(dataset * number_of_events_subset / number_of_datasets)</span>
        <span class="c1">#         end_dataset = np.int32((dataset + 1) * number_of_events_subset / number_of_datasets)</span>
        <span class="c1">#</span>
        <span class="c1">#     threadsperblock = (512, 1, 1)</span>
        <span class="c1">#     blockspergrid_x = int(math.ceil(((end_dataset - begin_dataset)) / threadsperblock[0]))</span>
        <span class="c1">#     blockspergrid_y = int(math.ceil(1 / threadsperblock[1]))</span>
        <span class="c1">#     blockspergrid_z = int(math.ceil(1 / threadsperblock[2]))</span>
        <span class="c1">#     blockspergrid = (blockspergrid_x, blockspergrid_y, blockspergrid_z)</span>
        <span class="c1">#     event[dataset][&#39;kernel_begin&#39;].record(stream[dataset])</span>
        <span class="c1">#</span>
        <span class="c1">#     func_prob = mod_probability_shared_mem.get_function(&quot;probability&quot;)</span>
        <span class="c1">#     func_prob(weight, height, depth, half_crystal_pitch_xy, half_crystal_pitch_z,</span>
        <span class="c1">#                  number_of_events, begin_dataset, end_dataset, a_cut_gpu[dataset], a_cut_normal_gpu[dataset],</span>
        <span class="c1">#                  b_cut_gpu[dataset], b_cut_normal_gpu[dataset], c_cut_gpu[dataset], c_cut_normal_gpu[dataset],</span>
        <span class="c1">#                  d_cut_gpu[dataset],</span>
        <span class="c1">#                  d_cut_normal_gpu[dataset], A_gpu, B_gpu, C_gpu, probability_gpu[dataset],</span>
        <span class="c1">#                  im_gpu,</span>
        <span class="c1">#                  block=threadsperblock,</span>
        <span class="c1">#                  grid=blockspergrid,</span>
        <span class="c1">#                  stream=stream[dataset])</span>
        <span class="c1">#</span>
        <span class="c1"># # Sincronization of streams</span>
        <span class="c1"># for dataset in range(number_of_datasets):  # Commenting out this line should break concurrency.</span>
        <span class="c1">#     event[dataset][&#39;kernel_end&#39;].record(stream[dataset])</span>
        <span class="c1">#</span>
        <span class="c1"># # Transfering data from Optimizer</span>
        <span class="c1"># for dataset in range(number_of_datasets):</span>
        <span class="c1">#     begin_dataset = np.int32(dataset * number_of_events / number_of_datasets)</span>
        <span class="c1">#     end_dataset = np.int32((dataset + 1) * number_of_events / number_of_datasets)</span>
        <span class="c1">#     cuda.memcpy_dtoh_async(probability[begin_dataset:end_dataset], probability_gpu[dataset])</span>

        <span class="c1"># cuda.memcpy_htod_async(probability_t_gpu, probability)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration number: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">----------------&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">begin_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">end_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">number_of_events</span> <span class="o">/</span> <span class="n">subsets</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subsets</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Subset number: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
                <span class="n">number_of_events_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">end_event</span> <span class="o">-</span> <span class="n">begin_event</span><span class="p">)</span>
                <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="c1"># Cycle forward Projection</span>
                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="n">number_of_datasets</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">number_of_events_subset</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>

                    <span class="n">threadsperblock</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">blockspergrid_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(((</span><span class="n">end_dataset</span> <span class="o">-</span> <span class="n">begin_dataset</span><span class="p">))</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">blockspergrid_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">blockspergrid_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">blockspergrid</span> <span class="o">=</span> <span class="p">(</span><span class="n">blockspergrid_x</span><span class="p">,</span> <span class="n">blockspergrid_y</span><span class="p">,</span> <span class="n">blockspergrid_z</span><span class="p">)</span>
                    <span class="n">event</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s1">&#39;kernel_begin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                    <span class="n">func_forward</span> <span class="o">=</span> <span class="n">mod_forward_projection_shared_mem</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="s2">&quot;forward_projection&quot;</span><span class="p">)</span>
                    <span class="n">func_forward</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">half_crystal_pitch_xy</span><span class="p">,</span> <span class="n">half_crystal_pitch_z</span><span class="p">,</span>
                                 <span class="n">distance_between_array_pixel</span><span class="p">,</span>
                                 <span class="n">number_of_events</span><span class="p">,</span> <span class="n">begin_dataset</span><span class="p">,</span> <span class="n">end_dataset</span><span class="p">,</span> <span class="n">a_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">a_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">a_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">b_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">b_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">b_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">c_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">c_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">c_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">d_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">d_cut_normal_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">d_cf_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">A_gpu</span><span class="p">,</span> <span class="n">B_gpu</span><span class="p">,</span> <span class="n">C_gpu</span><span class="p">,</span>
                                 <span class="n">sum_vor_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">sensivity_matrix_gpu</span><span class="p">,</span> <span class="n">im_gpu</span><span class="p">,</span> <span class="n">probability_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                 <span class="n">block</span><span class="o">=</span><span class="n">threadsperblock</span><span class="p">,</span>
                                 <span class="n">grid</span><span class="o">=</span><span class="n">blockspergrid</span><span class="p">,</span>
                                 <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                <span class="c1"># Sincronization of streams</span>
                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>  <span class="c1"># Commenting out this line should break concurrency.</span>
                    <span class="n">event</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s1">&#39;kernel_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                <span class="c1"># Transfering data from Optimizer</span>
                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
                    <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                    <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                    <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_dtoh_async</span><span class="p">(</span><span class="n">sum_vor</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">],</span> <span class="n">sum_vor_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
                    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time part Forward Projection </span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">))</span>

                <span class="c1"># number_of_datasets = np.int32(2)</span>
                <span class="n">teste</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sum_vor</span><span class="p">)</span>
                <span class="c1"># sum_vor=np.ascontiguousarray(np.ones((self.a.shape)), dtype=np.float32)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUM VOR: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">teste</span><span class="p">)))</span>
                <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">sum_vor_t_gpu</span><span class="p">,</span> <span class="n">sum_vor</span><span class="p">)</span>

                <span class="c1"># ------------BACKPROJECTION-----------</span>

                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="n">number_of_datasets</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">number_of_events_subset</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_of_events_subset</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>

                    <span class="c1"># begin_dataset = np.int32(0)</span>
                    <span class="c1"># end_dataset = np.int32(number_of_events)</span>

                    <span class="n">event</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s1">&#39;kernel_begin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
                    <span class="n">weight_cutted</span><span class="p">,</span> <span class="n">height_cutted</span><span class="p">,</span> <span class="n">depth_cutted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span>
                        <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="n">threadsperblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">blockspergrid_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">blockspergrid_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">blockspergrid_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">blockspergrid</span> <span class="o">=</span> <span class="p">(</span><span class="n">blockspergrid_x</span><span class="p">,</span> <span class="n">blockspergrid_y</span><span class="p">,</span> <span class="n">blockspergrid_z</span><span class="p">)</span>
                    <span class="n">shared_memory</span> <span class="o">=</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">threadsperblock</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
                    <span class="n">func_backward</span> <span class="o">=</span> <span class="n">mod_backward_projection_shared_mem</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="s2">&quot;backprojection&quot;</span><span class="p">)</span>

                    <span class="c1"># func_backward.prepare(dataset, weight_cutted, height_cutted, depth_cutted, half_crystal_pitch_xy, half_crystal_pitch_z, distance_between_array_pixel,</span>
                    <span class="c1">#      number_of_events, begin_dataset, end_dataset, a_gpu, a_normal_gpu, a_cf_gpu,</span>
                    <span class="c1">#      b_gpu, b_normal_gpu,b_cf_gpu, c_gpu, c_normal_gpu, c_cf_gpu, d_gpu,</span>
                    <span class="c1">#      d_normal_gpu, d_cf_gpu, A_cut_gpu[dataset], B_cut_gpu[dataset], C_cut_gpu[dataset], adjust_coef_gpu[dataset],</span>
                    <span class="c1">#      sum_vor_t_gpu, sensivity_gpu[dataset], probability_t_gpu, time_factor_gpu,shared=512)</span>
                    <span class="c1">#</span>
                    <span class="c1"># func.prepared_call(blockspergrid, threadsperblock, dataset, weight_cutted, height_cutted, depth_cutted, half_crystal_pitch_xy, half_crystal_pitch_z, distance_between_array_pixel,</span>
                    <span class="c1">#      number_of_events, begin_dataset, end_dataset, a_gpu, a_normal_gpu, a_cf_gpu,</span>
                    <span class="c1">#      b_gpu, b_normal_gpu,b_cf_gpu, c_gpu, c_normal_gpu, c_cf_gpu, d_gpu,</span>
                    <span class="c1">#      d_normal_gpu, d_cf_gpu, A_cut_gpu[dataset], B_cut_gpu[dataset], C_cut_gpu[dataset], adjust_coef_gpu[dataset],</span>
                    <span class="c1">#      sum_vor_t_gpu, sensivity_gpu[dataset], probability_t_gpu, time_factor_gpu)</span>
                    <span class="n">func_backward</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">weight_cutted</span><span class="p">,</span> <span class="n">height_cutted</span><span class="p">,</span> <span class="n">depth_cutted</span><span class="p">,</span> <span class="n">half_crystal_pitch_xy</span><span class="p">,</span>
                                  <span class="n">half_crystal_pitch_z</span><span class="p">,</span> <span class="n">distance_between_array_pixel</span><span class="p">,</span>
                                  <span class="n">number_of_events</span><span class="p">,</span> <span class="n">begin_dataset</span><span class="p">,</span> <span class="n">end_dataset</span><span class="p">,</span> <span class="n">a_gpu</span><span class="p">,</span> <span class="n">a_normal_gpu</span><span class="p">,</span> <span class="n">a_cf_gpu</span><span class="p">,</span>
                                  <span class="n">b_gpu</span><span class="p">,</span> <span class="n">b_normal_gpu</span><span class="p">,</span> <span class="n">b_cf_gpu</span><span class="p">,</span> <span class="n">c_gpu</span><span class="p">,</span> <span class="n">c_normal_gpu</span><span class="p">,</span> <span class="n">c_cf_gpu</span><span class="p">,</span> <span class="n">d_gpu</span><span class="p">,</span>
                                  <span class="n">d_normal_gpu</span><span class="p">,</span> <span class="n">d_cf_gpu</span><span class="p">,</span> <span class="n">A_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">B_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">C_cut_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                  <span class="n">adjust_coef_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                  <span class="n">sum_vor_t_gpu</span><span class="p">,</span> <span class="n">sensivity_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">probability_t_gpu</span><span class="p">,</span> <span class="n">time_factor_gpu</span><span class="p">,</span>
                                  <span class="n">block</span><span class="o">=</span><span class="n">threadsperblock</span><span class="p">,</span>
                                  <span class="n">grid</span><span class="o">=</span><span class="n">blockspergrid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span>
                                  <span class="p">)</span>

                <span class="c1"># shared=np.int(shared_memory),</span>

                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>  <span class="c1"># Commenting out this line should break concurrency.</span>
                    <span class="n">event</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s1">&#39;kernel_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
                    <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_dtoh_async</span><span class="p">(</span><span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">adjust_coef_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                    <span class="n">adjust_coef</span><span class="p">[:,</span> <span class="p">:,</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im_cut_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))]</span> <span class="o">=</span> \
                        <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time part Backward Projection </span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">toc</span><span class="p">))</span>

                <span class="c1"># Image Normalization</span>
                <span class="c1"># if i ==0:</span>
                <span class="c1">#     norm_im=np.copy(adjust_coef)</span>
                <span class="c1">#     norm_im=norm_im/np.max(norm_im)</span>
                <span class="c1">#     norm_im[norm_im == 0] = np.min(norm_im[np.nonzero(norm_im)])</span>
                <span class="c1"># normalization_matrix = gaussian_filter(normalization_matrix, 0.5)</span>

                <span class="c1"># im_med = np.load(&quot;C:\\Users\\pedro.encarnacao\\OneDrive - Universidade de Aveiro\\PhD\\Reconstrução\\NAF+FDG\\Easypet Scan 05 Aug 2019 - 14h 36m 33s\\static_image\\Easypet Scan 05 Aug 2019 - 14h 36m 33s mlem.npy&quot;)</span>
                <span class="c1"># self.algorithm = &quot;LM-MRP&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;LM-MRP&quot;</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">kernel_filter_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">im_med</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">kernel_filter_size</span><span class="p">)</span>
                    <span class="n">penalized_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                    <span class="n">penalized_term</span><span class="p">[</span><span class="n">im_med</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">im_med</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">im_med</span><span class="p">[</span><span class="n">im_med</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">im_med</span><span class="p">[</span>
                        <span class="n">im_med</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">penalized_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">penalized_term</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;MAP&quot;</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="n">im_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">pedro.encarnacao</span><span class="se">\\</span><span class="s2">OneDrive - Universidade de Aveiro</span><span class="se">\\</span><span class="s2">PhD</span><span class="se">\\</span><span class="s2">Reconstrução</span><span class="se">\\</span><span class="s2">NAF+FDG</span><span class="se">\\</span><span class="s2">Easypet Scan 05 Aug 2019 - 14h 36m 33s</span><span class="se">\\</span><span class="s2">static_image</span><span class="se">\\</span><span class="s2">Easypet Scan 05 Aug 2019 - 14h 36m 33s mlem.npy&quot;</span><span class="p">)</span>

                <span class="n">im</span><span class="p">[</span><span class="n">normalization_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">normalization_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">adjust_coef</span><span class="p">[</span>
                    <span class="n">normalization_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">normalization_matrix</span><span class="p">[</span><span class="n">normalization_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_matrix</span><span class="p">[</span><span class="n">normalization_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">im</span><span class="p">[</span><span class="n">normalization_matrix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;LM-MRP&quot;</span><span class="p">:</span>
                    <span class="n">im</span><span class="p">[</span><span class="n">penalized_term</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">penalized_term</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">penalized_term</span><span class="p">[</span><span class="n">penalized_term</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># im = fourier_gaussian(im, sigma=0.2)</span>
                <span class="c1"># im = gaussian_filter(im, 0.4)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUM IMAGE: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="c1"># im = im * adjust_coef / sensivity_matrix[np.nonzero(sensivity_matrix)]</span>
                <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">im_gpu</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>

                <span class="c1"># Clearing variables</span>
                <span class="n">sum_vor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

                <span class="n">adjust_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_pixels_z</span><span class="p">),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_datasets</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="n">number_of_datasets</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">number_of_events</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">begin_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dataset</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="n">end_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">dataset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_of_events</span> <span class="o">/</span> <span class="n">number_of_datasets</span><span class="p">)</span>
                        <span class="c1"># adjust_coef_cut[dataset] = np.ascontiguousarray(adjust_coef[:, :,</span>
                        <span class="c1">#                                                 int(np.floor(im_cut_dim[2] * dataset)):int(</span>
                        <span class="c1">#                                                     np.floor(im_cut_dim[2] * (dataset + 1)))],</span>
                        <span class="c1">#                                                 dtype=np.float32)</span>
                        <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_coef</span>

                    <span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_vor</span><span class="p">[</span><span class="n">begin_dataset</span><span class="p">:</span><span class="n">end_dataset</span><span class="p">]</span>
                    <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">sum_vor_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">sum_vor_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
                    <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod_async</span><span class="p">(</span><span class="n">adjust_coef_gpu</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">adjust_coef_cut</span><span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_image_by_iteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_image_by_it</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sb</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals_interface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">signals_interface</span><span class="o">.</span><span class="n">trigger_update_label_reconstruction_status</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Iteration </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_info_step</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">signals_interface</span><span class="o">.</span><span class="n">trigger_progress_reconstruction_partial</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sb</span> <span class="o">+</span> <span class="n">subsets</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="n">subsets</span><span class="p">),</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">im</span> <span class="o">*</span> <span class="n">subsets</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Pedro Encarnação.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>